@model VisitViewModel
@{
    ViewData["Title"] = "Посещения";
}
<br />
<h2 class="text-muted text-center" style="margin-top:0;">Добавление посещения</h2>
<br />
<h6 class="text-muted text-center">Группа: <b>@Model.Input.Group.Name</b>. Предмет: <b>@Model.Input.Subject.Name</b>.</h6>
<br />
@{int events = Convert.ToInt32(Model.Input.Time / 2);}
<form asp-controller="Visit" asp-action="AddVisit">
    <input asp-for="@Model.SubjectId" value="@Model.Input.Subject.Id" type="hidden" />
    <input asp-for="@Model.GroupId" value="@Model.Input.Group.Id" type="hidden" />
    <input asp-for="@Model.Input.Time" type="hidden" />
    <table class="table table-bordered">
        <thead align="center">
            <tr>
                <th rowspan="2">Студент</th>
                <th colspan="@events">Дата:   <input asp-for="@Model.Date" type="date" placeholder="Дата" /> </th>
            </tr>
            <tr>
                    <th>
                        <div class="row">
                            <div class="col">
                                Тип занятия:
                                <select id='@($"TypeSubject_1")' class="form-control" asp-for="@Model.Output.TypeSubject"
                                        asp-items="@Html.GetEnumSelectList(typeof(Eljur.Context.Tables.TypeSubjectEnum))" onchange="GetThemesList(1)"></select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                Тема:
                                <select id='@($"Theme_1")' class="form-control" asp-for="@Model.Output.ThemeId" required>
                                    <option disabled selected value=''>Не выбрано</option>
                                </select>
                            </div>
                        </div>
                    </th>
            </tr>
        </thead>
        <tbody>
            @{ var counter = 0;}
            @foreach (var student in Model.Input.Group.Students.OrderBy(x => x.FIO))
            {
                <tr>
                    <td>@student.FIO</td>
                        <td>
                            <input asp-for="@Model.Output.VisitsModify[counter].StudentId" value="@student.Id" type="hidden" />

                            <select class="form-control" asp-for="@Model.Output.VisitsModify[counter].TypeVisit"
                                    asp-items="@Html.GetEnumSelectList(typeof(Eljur.Context.Tables.TypeVisitEnum))">
                            </select>
                        </td>
                </tr>
                counter++;
            }
        </tbody>
    </table>
    <button class="btn btn-success">Добавить</button>
</form>
<script>

    //начальная инициализация
    $(document).ready(function () {
        for (i = 0; i < @events; i++) {
            GetThemesList(i);
        }
    });

    //загружаем при помощи get запроса список доступных тем
    async function GetThemesList(i) {
        let typeSubject = $("#TypeSubject_" + i).val();
        let subjectId = $("#SubjectId").val();

        let response = await fetch("GetThemesList/?typeSubject=" + typeSubject + "&subjectId=" + subjectId );
        if (response.ok) {
            $("#Theme_" + i).empty();
            $("#Theme_" + i).append(await response.text());
        }
    }
</script>